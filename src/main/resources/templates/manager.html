<div class="admin-container">
    <div class="nav-btns">
        <button onclick="showSection('user')" data-section="user" class="active">User </button>
    </div>
    <div id="user" class="section active">
        <button class="btn btn-add-user btn-add-item" data-form-id="addUserForm">üë• Th√™m ng∆∞·ªùi d√πng</button>
        <div id="addUserForm" class="add-form-container">
            <h3>Th√™m ng∆∞·ªùi d√πng m·ªõi</h3>
            <button class="btn btn-close-form">‚úñÔ∏è H·ªßy</button>
            <form action="">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fullName">H·ªç v√† t√™n</label>
                        <input type="text" id="fullName" placeholder="Nh·∫≠p h·ªç v√† t√™n" class="form-control-custom">
                    </div>
                    <div class="form-group">
                        <label for="roleSelect">Vai tr√≤</label>
                        <select id="roleSelect" class="form-control-custom">
                            <option value="">Ch·ªçn vai tr√≤</option>

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="storeSelect">C·ª≠a h√†ng</label>
                        <select id="storeSelect" class="form-control-custom">
                            <option value="">Ch·ªçn c·ª≠a h√†ng</option>
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="branch1">Chi nh√°nh Trung t√¢m</option>
                            <option value="STORE003">C·ª≠a h√†ng B√°nh ng·ªçt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="usernames">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" id="usernames" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" class="form-control-custom">
                    </div>
                    <div class="form-group">
                        <label for="passwords">M·∫≠t Kh·∫©u</label>
                        <input type="password" id="passwords" placeholder="Nh·∫≠p M·∫≠t kh·∫©u" class="form-control-custom">
                    </div>
                    <div class="form-group">
                        <label for="NS">Ng√†y sinh</label>
                        <input type="date" id="NS" placeholder="Ng√†y sinh" class="form-control-custom">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-success" id="Them" type="button">‚ûï Th√™m ng∆∞·ªùi d√πng</button>
                    <button class="btn btn-secondary btn-close-form" type="button">H·ªßy</button>
                </div>
            </form>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n ng∆∞·ªùi d√πng</th>
                    <th>T√™n ƒëƒÉng nh·∫≠p</th>
                    <th>M·∫≠t kh·∫©u</th>
                    <th>Vai tr√≤</th>
                    <th>C·ª≠a h√†ng</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="staff-body">
                <tr>
                    <td>${u.id}</td>
                    <td><input type="text" value="${u.name}" style="border: 0px;background: none;"></td>
                    <td><input type="text" value="${u.name}" style="border: 0px;background: none;"></td>
                    <td><input type="text" value="${u.name}" style="border: 0px;background: none;"></td>
                    <td>${u.roles.map(r => `<span>${r.role_name}</span>`).join(", ")}</td>
                    <td>${u.store?.name || "Kh√¥ng r√µ"}</td>
                    <td>
                        <button class="btn btn-sm btn-primary">Ch·ªânh s·ª≠a</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">V√¥ hi·ªáu</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    user = [];

    async function fetchAllUsers() {
        try {
            const res = await fetch("http://localhost:8080/api/admin/all_NV");
            if (!res.ok) throw new Error("L·ªói server");
            user = await res.json();
            renderUserTable(user);
        } catch (err) {
            console.error("L·ªói t·∫£i danh s√°ch nh√¢n vi√™n:", err);
            document.getElementById('staff-body').innerHTML = `
        <tr><td colspan="5" class="text-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu nh√¢n vi√™n</td></tr>
      `;
        }
    }

    function renderUserTable(data) {
        const tbody = document.getElementById("staff-body");
        tbody.innerHTML = data.map(u => `
      <tr>
        <td>${u.id}</td>
        <td><input type="text" value="${u.name}" style="border: 0px;background: none;"></td>
        <td><input type="text" value="${u.user_name}" style="border: 0px;background: none;"></td>
        <td><input type="text" value="${u.passwords}" style="border: 0px;background: none;"></td>
            <td>${u.roles.map(r => `<span>${r.role_name}</span>`).join(", ")}</td>
            <td>${u.ten_cua_hang || "Kh√¥ng r√µ"}</td>
        <td>
            <button class="btn btn-sm btn-primary" onclick="logRowData(this, '${u.id}')">Ch·ªânh s·ª≠a</button>
            <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">V√¥ hi·ªáu</button>
        </td>
    </tr>
    `).join("");
    }



    document.addEventListener("DOMContentLoaded", fetchAllUsers());

    document.addEventListener("DOMContentLoaded", fetchAllUsers(), fetchRoles(), fetchStore());

    function generateMaNV() {
        const prefix = "NV";
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let result = prefix;
        for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }
    document.getElementById("Them").addEventListener("click", function () {
        const roleSelect = document.getElementById("roleSelect")
        const data = {
            ma_nv: generateMaNV(),
            ten: document.getElementById("fullName").value,
            username: document.getElementById("usernames").value,
            passwords: document.getElementById("passwords").value,
            dia_chi: "",

            luong: 0,
            birthday: document.getElementById("NS").value,
            lien_he: [
                ""
            ],
            IDCH: document.getElementById("storeSelect").value,
            roles: [
                {
                    role_id: roleSelect.value,
                    role_name: roleSelect.options[roleSelect.selectedIndex].text
                },
            ]
        };
        console.log(data)
        fetch("http://localhost:8080/api/admin/tao_nhan_vien", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        }).then(response => response.text())
            .then(result => {
                alert(result);
                user.push({
                    id: data.ma_nv,
                    name: data.ten,
                    user_name: data.username,
                    passwords: data.passwords,
                    roles: data.roles,
                    ten_cua_hang: document.getElementById("storeSelect").options[storeSelect.selectedIndex].text
                });
                renderUserTable(user);
            })
            .catch(error => {
                alert(error);
            })
    })
    async function fetchRoles() {
        try {
            const ls_role = document.getElementById("roleSelect");
            const res = await fetch("http://localhost:8080/api/admin/all_role");
            if (!res.ok) throw new Error("Kh√¥ng load ƒë∆∞·ª£c role");

            const roles_data = await res.json();


            ls_role.innerHTML = `<option value="">Ch·ªçn vai tr√≤</option>` +
                roles_data.map(item => `
                <option value="${item.role_id}">${item.role_name}</option>
            `).join("");

        } catch (error) {
            console.error("L·ªói load role:", error);
            alert("L·ªói: " + error.message);
        }
    }

    async function fetchStore() {
        try {
            const ls_Store = document.getElementById("storeSelect");
            const res = await fetch("http://localhost:8080/api/admin/all_CH");
            if (!res.ok) throw new Error("Kh√¥ng load ƒë∆∞·ª£c c·ª≠a h√†ng");

            const Stores_data = await res.json();


            ls_Store.innerHTML = `<option value="">Ch·ªçn vai tr√≤</option>` +
                Stores_data.map(item => `
                <option value="${item.store_id}">${item.ten_cua_hang}</option>
            `).join("");

        } catch (error) {
            console.error("L·ªói load role:", error);
            alert("L·ªói: " + error.message);
        }
    }

    function deleteUser(ma_nv) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° nh√¢n vi√™n n√†y?")) return;
        console.log(ma_nv);
        fetch(`http://localhost:8080/api/admin/xoa_nv?id=${ma_nv}`, {
            method: "DELETE",
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Xo√° th·∫•t b·∫°i");
                }

                return response.text();
            })
            .then(result => {
                alert(result);
                // Sau khi xo√°, load l·∫°i danh s√°ch
                fetchAllUsers(); // gi·∫£ s·ª≠ b·∫°n ƒë√£ c√≥ h√†m n√†y ƒë·ªÉ load l·∫°i danh s√°ch
            })
            .catch(error => {
                alert("L·ªói: " + error.message);
            });
    }

    function logRowData(button, id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t nh√¢n vi√™n n√†y?")) return;
        const row = button.closest("tr");
        const [nameInput, usernameInput, passwordInput] = row.querySelectorAll("input");

        const data = {
            ma_nv: id,
            ten: nameInput.value,
            username: usernameInput.value,
            passwords: passwordInput.value,
            dia_chi: "",
            luong: 0,
            lien_he: [
                ""
            ]
        };
        fetch("http://localhost:8080/api/admin/chinh_sua_thong_tin_nv", {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("C·∫≠p nh·∫≠t th·∫•t b·∫°i");
                }
                fetchAllUsers();
                return response.text();
            })
            .then(result => {
                alert(result); // ho·∫∑c hi·ªÉn th·ªã message b·∫±ng toast
            })
            .catch(error => {
                console.error("L·ªói:", error);
                alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i");
            });

    }
</script>